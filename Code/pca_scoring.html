<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en"><head>

<meta charset="utf-8">
<meta name="generator" content="quarto-1.6.42">

<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">


<title>Review Data Cleaning and PCA Modeling</title>
<style>
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
div.columns{display: flex; gap: min(4vw, 1.5em);}
div.column{flex: auto; overflow-x: auto;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
ul.task-list li input[type="checkbox"] {
  width: 0.8em;
  margin: 0 0.8em 0.2em -1em; /* quarto-specific, see https://github.com/quarto-dev/quarto-cli/issues/4556 */ 
  vertical-align: middle;
}
/* CSS for syntax highlighting */
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
  }
pre.numberSource { margin-left: 3em;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
</style>


<script src="pca_scoring_files/libs/clipboard/clipboard.min.js"></script>
<script src="pca_scoring_files/libs/quarto-html/quarto.js"></script>
<script src="pca_scoring_files/libs/quarto-html/popper.min.js"></script>
<script src="pca_scoring_files/libs/quarto-html/tippy.umd.min.js"></script>
<script src="pca_scoring_files/libs/quarto-html/anchor.min.js"></script>
<link href="pca_scoring_files/libs/quarto-html/tippy.css" rel="stylesheet">
<link href="pca_scoring_files/libs/quarto-html/quarto-syntax-highlighting-2f5df379a58b258e96c21c0638c20c03.css" rel="stylesheet" id="quarto-text-highlighting-styles">
<script src="pca_scoring_files/libs/bootstrap/bootstrap.min.js"></script>
<link href="pca_scoring_files/libs/bootstrap/bootstrap-icons.css" rel="stylesheet">
<link href="pca_scoring_files/libs/bootstrap/bootstrap-1bc8a17f135ab3d594c857e9f48e611b.min.css" rel="stylesheet" append-hash="true" id="quarto-bootstrap" data-mode="light">


</head>

<body class="fullcontent">

<div id="quarto-content" class="page-columns page-rows-contents page-layout-article">

<main class="content" id="quarto-document-content">

<header id="title-block-header" class="quarto-title-block default">
<div class="quarto-title">
<h1 class="title">Review Data Cleaning and PCA Modeling</h1>
</div>



<div class="quarto-title-meta">

    
  
    
  </div>
  


</header>


<section id="preliminaries" class="level2">
<h2 class="anchored" data-anchor-id="preliminaries">Preliminaries</h2>
<p>Import libraries.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb1"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(tidyverse)</span>
<span id="cb1-2"><a href="#cb1-2" aria-hidden="true" tabindex="-1"></a><span class="fu">library</span>(factoextra)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Import reviewer-review level data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb2"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="co"># this is a big data set! This takes a minute or two</span></span>
<span id="cb2-2"><a href="#cb2-2" aria-hidden="true" tabindex="-1"></a><span class="co"># we are subsetting this to speed up initial computations</span></span>
<span id="cb2-3"><a href="#cb2-3" aria-hidden="true" tabindex="-1"></a>review <span class="ot">&lt;-</span> <span class="fu">read_csv</span>(<span class="st">"../Data/final_modeling_df.csv"</span>) <span class="co"># |&gt; slice(1:1000000)</span></span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stderr">
<pre><code>Rows: 6990280 Columns: 22
── Column specification ────────────────────────────────────────────────────────
Delimiter: ","
chr   (6): review_id, user_id, business_id, text, product_attributes, sentiment
dbl  (15): stars, active_days, review_count, review_frequency, review_length...
dttm  (1): date

ℹ Use `spec()` to retrieve the full column specification for this data.
ℹ Specify the column types or set `show_col_types = FALSE` to quiet this message.</code></pre>
</div>
</div>
</section>
<section id="data-cleaning-visualization" class="level2">
<h2 class="anchored" data-anchor-id="data-cleaning-visualization">Data Cleaning + Visualization</h2>
<p>Check the structure of the data. Check for duplicate user IDs based on <code>review_count</code>.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb4"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check data structure and identify reviewer vs review level variables</span></span>
<span id="cb4-2"><a href="#cb4-2" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Dataset dimensions:"</span>, <span class="fu">dim</span>(review), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Dataset dimensions: 6990280 22 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb6"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique users:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(review<span class="sc">$</span>user_id)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unique users: 1987929 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb8"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" aria-hidden="true" tabindex="-1"></a><span class="fu">cat</span>(<span class="st">"Unique businesses:"</span>, <span class="fu">length</span>(<span class="fu">unique</span>(review<span class="sc">$</span>business_id)), <span class="st">"</span><span class="sc">\n</span><span class="st">"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Unique businesses: 150346 </code></pre>
</div>
<div class="sourceCode cell-code" id="cb10"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Check for duplicate user-level information based on review_count</span></span>
<span id="cb10-2"><a href="#cb10-2" aria-hidden="true" tabindex="-1"></a>review <span class="sc">|&gt;</span></span>
<span id="cb10-3"><a href="#cb10-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_id) <span class="sc">|&gt;</span></span>
<span id="cb10-4"><a href="#cb10-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-5"><a href="#cb10-5" aria-hidden="true" tabindex="-1"></a>    <span class="at">unique_review_counts =</span> <span class="fu">n_distinct</span>(review_count),</span>
<span id="cb10-6"><a href="#cb10-6" aria-hidden="true" tabindex="-1"></a>    <span class="at">.groups =</span> <span class="st">'drop'</span></span>
<span id="cb10-7"><a href="#cb10-7" aria-hidden="true" tabindex="-1"></a>  ) <span class="sc">|&gt;</span></span>
<span id="cb10-8"><a href="#cb10-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">summarise</span>(</span>
<span id="cb10-9"><a href="#cb10-9" aria-hidden="true" tabindex="-1"></a>    <span class="at">users_with_varying_review_count =</span> <span class="fu">sum</span>(unique_review_counts <span class="sc">&gt;</span> <span class="dv">1</span>),</span>
<span id="cb10-10"><a href="#cb10-10" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 1 × 1
  users_with_varying_review_count
                            &lt;int&gt;
1                               0</code></pre>
</div>
</div>
<p>Check summary statistics.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb12"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(review)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>  review_id           user_id          business_id            stars      
 Length:6990280     Length:6990280     Length:6990280     Min.   :1.000  
 Class :character   Class :character   Class :character   1st Qu.:3.000  
 Mode  :character   Mode  :character   Mode  :character   Median :4.000  
                                                          Mean   :3.749  
                                                          3rd Qu.:5.000  
                                                          Max.   :5.000  
                                                                         
     text                date                         active_days  
 Length:6990280     Min.   :2005-02-16 03:23:22.00   Min.   :   1  
 Class :character   1st Qu.:2015-01-25 04:53:50.25   1st Qu.:  38  
 Mode  :character   Median :2017-06-03 01:26:07.00   Median : 996  
                    Mean   :2017-01-11 11:22:33.44   Mean   :1280  
                    3rd Qu.:2019-05-23 00:02:46.25   3rd Qu.:2148  
                    Max.   :2022-01-19 19:48:45.00   Max.   :6004  
                                                                   
  review_count     review_frequency   review_length    product_attributes
 Min.   :    0.0   Min.   : 0.00035   Min.   :   1.0   Length:6990280    
 1st Qu.:    7.0   1st Qu.: 0.00815   1st Qu.:  42.0   Class :character  
 Median :   24.0   Median : 0.02742   Median :  75.0   Mode  :character  
 Mean   :  123.8   Mean   : 0.37879   Mean   : 104.8                     
 3rd Qu.:   98.0   3rd Qu.: 0.25373   3rd Qu.: 133.0                     
 Max.   :17473.0   Max.   :44.00000   Max.   :1070.0                     
 NA's   :33                                                              
  sentiment         sentiment_score   useful_user       funny_user      
 Length:6990280     Min.   :0.5000   Min.   :     0   Min.   :     0.0  
 Class :character   1st Qu.:0.9960   1st Qu.:     3   1st Qu.:     0.0  
 Mode  :character   Median :0.9993   Median :    19   Median :     3.0  
                    Mean   :0.9818   Mean   :   428   Mean   :   176.1  
                    3rd Qu.:0.9998   3rd Qu.:   111   3rd Qu.:    24.0  
                    Max.   :0.9999   Max.   :206296   Max.   :185823.0  
                                     NA's   :33       NA's   :33        
   cool_user        useful_review       funny_review       cool_review      
 Min.   :     0.0   Min.   :  -1.000   Min.   : -1.0000   Min.   : -1.0000  
 1st Qu.:     0.0   1st Qu.:   0.000   1st Qu.:  0.0000   1st Qu.:  0.0000  
 Median :     4.0   Median :   0.000   Median :  0.0000   Median :  0.0000  
 Mean   :   290.1   Mean   :   1.185   Mean   :  0.3266   Mean   :  0.4986  
 3rd Qu.:    39.0   3rd Qu.:   1.000   3rd Qu.:  0.0000   3rd Qu.:  0.0000  
 Max.   :199878.0   Max.   :1182.000   Max.   :792.0000   Max.   :404.0000  
 NA's   :33                                                                 
 star_rating_variance account_age_days average_stars  
 Min.   :0.0000       Min.   :   0     Min.   :1.000  
 1st Qu.:0.0000       1st Qu.:2247     1st Qu.:3.390  
 Median :0.9401       Median :3061     Median :3.880  
 Mean   :1.3337       Mean   :3017     Mean   :3.746  
 3rd Qu.:1.9978       3rd Qu.:3839     3rd Qu.:4.290  
 Max.   :8.0000       Max.   :6308     Max.   :5.000  
                      NA's   :33       NA's   :33     </code></pre>
</div>
</div>
<p>Compute the sum of <code>NA</code> values in each column. Most of the NA values are coming from product attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb14"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(review, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>           review_id              user_id          business_id 
                   0                    0                    0 
               stars                 text                 date 
                   0                    0                    0 
         active_days         review_count     review_frequency 
                   0                   33                    0 
       review_length   product_attributes            sentiment 
                   0               469119                    0 
     sentiment_score          useful_user           funny_user 
                   0                   33                   33 
           cool_user        useful_review         funny_review 
                  33                    0                    0 
         cool_review star_rating_variance     account_age_days 
                   0                    0                   33 
       average_stars 
                  33 </code></pre>
</div>
</div>
<p>View some rows with missing values of product_attributes.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb16"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" aria-hidden="true" tabindex="-1"></a>review <span class="sc">|&gt;</span></span>
<span id="cb16-2"><a href="#cb16-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(product_attributes)) <span class="sc">|&gt;</span></span>
<span id="cb16-3"><a href="#cb16-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 22
   review_id     user_id business_id stars text  date                active_days
   &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt; &lt;dttm&gt;                    &lt;dbl&gt;
 1 J-4NdnDZ0pUQ… vrKkXs… rjuWz_AD3W…     5 "I t… 2012-12-04 16:46:20         637
 2 qS6kE7CDoDag… zoBajE… c-IgS6Pk6v…     4 "Wen… 2015-06-08 19:45:48        1867
 3 4KpIldEM-tdn… Z5j9Xw… HTqXI5S2Xc…     5 "I'v… 2018-03-23 14:35:33        1436
 4 Lk21QNbrI_e3… bCla27… sLgnx_WFCj…     5 "Our… 2014-10-27 16:31:37        2470
 5 xumAI7br1X67… jEmClJ… X_E7U2lVNE…     5 "Thi… 2017-06-17 17:46:55        1365
 6 onlgwy5qGDEz… pYXeL0… W7NxQw8UYF…     4 "Don… 2012-02-01 14:21:25        2197
 7 PPgbLBvi34A6… 3TL6HZ… GyC36Pn0Q1…     1 "Ser… 2013-12-07 13:17:13        3157
 8 zcj7iTXdSz0G… X8XCFM… Zx7n8mdt8O…     5 "A m… 2018-01-21 17:12:47         359
 9 quiZPC8t-iZs… TTibuR… -ikBycdroy…     5 "Sto… 2014-09-25 18:36:53        1544
10 RMho6HMpdec1… SNngOV… ab3pRv-b0o…     5 "My … 2018-08-24 00:52:13         899
# ℹ 15 more variables: review_count &lt;dbl&gt;, review_frequency &lt;dbl&gt;,
#   review_length &lt;dbl&gt;, product_attributes &lt;chr&gt;, sentiment &lt;chr&gt;,
#   sentiment_score &lt;dbl&gt;, useful_user &lt;dbl&gt;, funny_user &lt;dbl&gt;,
#   cool_user &lt;dbl&gt;, useful_review &lt;dbl&gt;, funny_review &lt;dbl&gt;,
#   cool_review &lt;dbl&gt;, star_rating_variance &lt;dbl&gt;, account_age_days &lt;dbl&gt;,
#   average_stars &lt;dbl&gt;</code></pre>
</div>
</div>
<p>View rows with missing values of review_count.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb18"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" aria-hidden="true" tabindex="-1"></a>review <span class="sc">|&gt;</span></span>
<span id="cb18-2"><a href="#cb18-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">is.na</span>(review_count)) <span class="sc">|&gt;</span></span>
<span id="cb18-3"><a href="#cb18-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">head</span>(<span class="dv">10</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 10 × 22
   review_id     user_id business_id stars text  date                active_days
   &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt; &lt;dttm&gt;                    &lt;dbl&gt;
 1 HS2Og8fu_9lz… tquAg8… vpz_l8QIPS…     5 "Dr … 2022-01-19 18:32:46           1
 2 TZMTtzsG7hIy… 5iBVQ3… tsx84z4c0B…     4 "Fir… 2022-01-19 19:37:15           1
 3 rrXJ9Eux82kl… u8cq-5… j8JOZvfeHE…     5 "Bea… 2022-01-19 18:10:52           1
 4 iyoDkW-8aneK… 433Bzx… Al7JOgn9Ch…     1 "Ter… 2022-01-19 19:06:14           1
 5 XuqkOMPkmKsK… dWZlWF… P5qMWIfibf…     1 "Exo… 2022-01-19 17:22:03           1
 6 JVuwa9WSsFe5… sxxnBQ… P5qMWIfibf…     5 "Our… 2022-01-19 17:32:01           1
 7 GZmjLeVfDktq… MaengE… kZTwub3IkB…     1 "Ord… 2022-01-19 17:45:25           1
 8 ebQaTudrnT1w… 5XiPz5… H0UeLT7rL0…     5 "Awe… 2022-01-19 18:34:30           1
 9 EZ0mbYE2xvG7… I200Iy… 4H6KdEMRlS…     5 "Pic… 2022-01-19 17:31:13           1
10 1pcF0fYcXZ2V… G0PWeU… mQZpnPY7o2…     1 "Thi… 2022-01-19 17:30:20           1
# ℹ 15 more variables: review_count &lt;dbl&gt;, review_frequency &lt;dbl&gt;,
#   review_length &lt;dbl&gt;, product_attributes &lt;chr&gt;, sentiment &lt;chr&gt;,
#   sentiment_score &lt;dbl&gt;, useful_user &lt;dbl&gt;, funny_user &lt;dbl&gt;,
#   cool_user &lt;dbl&gt;, useful_review &lt;dbl&gt;, funny_review &lt;dbl&gt;,
#   cool_review &lt;dbl&gt;, star_rating_variance &lt;dbl&gt;, account_age_days &lt;dbl&gt;,
#   average_stars &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Deal with missing values. We impute empty strings for product attributes and drop rows with missing values in other variables. (Will revisit data cleaning to figure out why these missing values exist).</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb20"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" aria-hidden="true" tabindex="-1"></a>review <span class="ot">&lt;-</span> review <span class="sc">|&gt;</span> </span>
<span id="cb20-2"><a href="#cb20-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb20-3"><a href="#cb20-3" aria-hidden="true" tabindex="-1"></a>    <span class="co"># Impute missing product attributes with empty strings</span></span>
<span id="cb20-4"><a href="#cb20-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">product_attributes =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(product_attributes), <span class="st">""</span>, product_attributes),</span>
<span id="cb20-5"><a href="#cb20-5" aria-hidden="true" tabindex="-1"></a>  )</span>
<span id="cb20-6"><a href="#cb20-6" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb20-7"><a href="#cb20-7" aria-hidden="true" tabindex="-1"></a>review <span class="ot">&lt;-</span> review <span class="sc">|&gt;</span></span>
<span id="cb20-8"><a href="#cb20-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="fu">if_all</span>(<span class="fu">everything</span>(), <span class="sc">~!</span><span class="fu">is.na</span>(.)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>View the data. Some variables are reviewer-level (they have the same value across all reviewer-specific observations) and some are review-level.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb21"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" aria-hidden="true" tabindex="-1"></a>review <span class="sc">|&gt;</span></span>
<span id="cb21-2"><a href="#cb21-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(user_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 6,990,247 × 22
   review_id     user_id business_id stars text  date                active_days
   &lt;chr&gt;         &lt;chr&gt;   &lt;chr&gt;       &lt;dbl&gt; &lt;chr&gt; &lt;dttm&gt;                    &lt;dbl&gt;
 1 rJ3CASyRfG-7… ---1lK… f19eLfhXqR…     5 "I h… 2018-12-19 22:26:22           1
 2 xJuVVh0wspQl… ---2Pm… hKameFsaXh…     5 "No … 2014-10-28 14:38:58        2377
 3 hdtWMFs_rFCD… ---2Pm… hKameFsaXh…     5 "Thi… 2014-07-10 04:15:23        2377
 4 LBxTq5kq_Eea… ---2Pm… KP5OncF2jh…     5 "Wha… 2015-06-27 23:38:13        2377
 5 --C3ehBCy19v… ---2Pm… igC3UWYb9R…     5 "Gre… 2013-04-03 19:06:00        2377
 6 Plgeha6t05uC… ---2Pm… RwgohauKm5…     5 "Gre… 2014-11-08 13:57:23        2377
 7 qRJ5SbFpofSw… ---2Pm… ZvI9Ytqx_S…     5 "I m… 2014-07-24 03:11:30        2377
 8 wXZD9m3KDCjG… ---2Pm… aOz57yKwap…     5 "Thi… 2018-11-10 02:27:23        2377
 9 PtiOktOk5COH… ---2Pm… eR7ieJD12P…     5 "Gre… 2012-11-02 00:30:24        2377
10 oPJZvPTykI8j… ---2Pm… hTA0eCoMdA…     5 "Wha… 2016-08-21 18:28:20        2377
# ℹ 6,990,237 more rows
# ℹ 15 more variables: review_count &lt;dbl&gt;, review_frequency &lt;dbl&gt;,
#   review_length &lt;dbl&gt;, product_attributes &lt;chr&gt;, sentiment &lt;chr&gt;,
#   sentiment_score &lt;dbl&gt;, useful_user &lt;dbl&gt;, funny_user &lt;dbl&gt;,
#   cool_user &lt;dbl&gt;, useful_review &lt;dbl&gt;, funny_review &lt;dbl&gt;,
#   cool_review &lt;dbl&gt;, star_rating_variance &lt;dbl&gt;, account_age_days &lt;dbl&gt;,
#   average_stars &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Compute summaries of review-level variables for each reviewer and additional features of interest.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb23"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" aria-hidden="true" tabindex="-1"></a>review <span class="ot">&lt;-</span> review <span class="sc">|&gt;</span></span>
<span id="cb23-2"><a href="#cb23-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">date =</span> <span class="fu">as.Date</span>(date)) <span class="sc">|&gt;</span></span>
<span id="cb23-3"><a href="#cb23-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">arrange</span>(user_id, date) <span class="sc">|&gt;</span></span>
<span id="cb23-4"><a href="#cb23-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">group_by</span>(user_id) <span class="sc">|&gt;</span></span>
<span id="cb23-5"><a href="#cb23-5" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb23-6"><a href="#cb23-6" aria-hidden="true" tabindex="-1"></a>         <span class="co"># compute the average review length for each reviewer </span></span>
<span id="cb23-7"><a href="#cb23-7" aria-hidden="true" tabindex="-1"></a>         <span class="at">avg_review_length =</span> <span class="fu">mean</span>(review_length),</span>
<span id="cb23-8"><a href="#cb23-8" aria-hidden="true" tabindex="-1"></a>         <span class="co"># compute the proportion of positive reviews written by a given reviewer</span></span>
<span id="cb23-9"><a href="#cb23-9" aria-hidden="true" tabindex="-1"></a>         <span class="at">avg_sentiment =</span> <span class="fu">mean</span>(sentiment <span class="sc">==</span> <span class="st">"POSITIVE"</span>),</span>
<span id="cb23-10"><a href="#cb23-10" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Consistency metrics</span></span>
<span id="cb23-11"><a href="#cb23-11" aria-hidden="true" tabindex="-1"></a>         <span class="at">review_length_variance =</span> <span class="fu">var</span>(review_length),</span>
<span id="cb23-12"><a href="#cb23-12" aria-hidden="true" tabindex="-1"></a>         <span class="at">time_between_reviews_variance =</span> <span class="fu">var</span>(<span class="fu">diff</span>(date)),</span>
<span id="cb23-13"><a href="#cb23-13" aria-hidden="true" tabindex="-1"></a>         <span class="co"># Suspicious patterns</span></span>
<span id="cb23-14"><a href="#cb23-14" aria-hidden="true" tabindex="-1"></a>         <span class="at">review_burst_count =</span> <span class="fu">sum</span>(<span class="fu">diff</span>(date) <span class="sc">&lt;</span> <span class="dv">1</span>),</span>
<span id="cb23-15"><a href="#cb23-15" aria-hidden="true" tabindex="-1"></a>         <span class="co"># proportion of reviews with 1 or 5 star ratings</span></span>
<span id="cb23-16"><a href="#cb23-16" aria-hidden="true" tabindex="-1"></a>         <span class="at">extreme_rating_proportion =</span> <span class="fu">mean</span>(stars <span class="sc">%in%</span> <span class="fu">c</span>(<span class="dv">1</span>, <span class="dv">5</span>))) <span class="sc">|&gt;</span></span>
<span id="cb23-17"><a href="#cb23-17" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ungroup</span>() </span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Check for missing values in the newly created variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb24"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" aria-hidden="true" tabindex="-1"></a><span class="fu">apply</span>(review, <span class="dv">2</span>, <span class="cf">function</span>(x) <span class="fu">sum</span>(<span class="fu">is.na</span>(x)))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>                    review_id                       user_id 
                            0                             0 
                  business_id                         stars 
                            0                             0 
                         text                          date 
                            0                             0 
                  active_days                  review_count 
                            0                             0 
             review_frequency                 review_length 
                            0                             0 
           product_attributes                     sentiment 
                            0                             0 
              sentiment_score                   useful_user 
                            0                             0 
                   funny_user                     cool_user 
                            0                             0 
                useful_review                  funny_review 
                            0                             0 
                  cool_review          star_rating_variance 
                            0                             0 
             account_age_days                 average_stars 
                            0                             0 
            avg_review_length                 avg_sentiment 
                            0                             0 
       review_length_variance time_between_reviews_variance 
                      1135977                       1779157 
           review_burst_count     extreme_rating_proportion 
                            0                             0 </code></pre>
</div>
</div>
<p>Replace missing values for <code>review_length_variance</code> and <code>time_between_reviews_variance</code> with 0, as these metrics are not applicable for users with only one review.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb26"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" aria-hidden="true" tabindex="-1"></a>review <span class="ot">&lt;-</span> review <span class="sc">|&gt;</span></span>
<span id="cb26-2"><a href="#cb26-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(</span>
<span id="cb26-3"><a href="#cb26-3" aria-hidden="true" tabindex="-1"></a>    <span class="at">review_length_variance =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(review_length_variance), <span class="dv">0</span>, review_length_variance),</span>
<span id="cb26-4"><a href="#cb26-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">time_between_reviews_variance =</span> <span class="fu">ifelse</span>(<span class="fu">is.na</span>(time_between_reviews_variance), <span class="dv">0</span>, time_between_reviews_variance)</span>
<span id="cb26-5"><a href="#cb26-5" aria-hidden="true" tabindex="-1"></a>  )</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Select reviewer-level variables and pivot to long format.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb27"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" aria-hidden="true" tabindex="-1"></a><span class="co"># create data frame with user-level variables and ID</span></span>
<span id="cb27-2"><a href="#cb27-2" aria-hidden="true" tabindex="-1"></a>review_user <span class="ot">&lt;-</span> review <span class="sc">|&gt;</span></span>
<span id="cb27-3"><a href="#cb27-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">select</span>(user_id, </span>
<span id="cb27-4"><a href="#cb27-4" aria-hidden="true" tabindex="-1"></a>         active_days, </span>
<span id="cb27-5"><a href="#cb27-5" aria-hidden="true" tabindex="-1"></a>         review_count,</span>
<span id="cb27-6"><a href="#cb27-6" aria-hidden="true" tabindex="-1"></a>         review_frequency,</span>
<span id="cb27-7"><a href="#cb27-7" aria-hidden="true" tabindex="-1"></a>         time_between_reviews_variance,</span>
<span id="cb27-8"><a href="#cb27-8" aria-hidden="true" tabindex="-1"></a>         review_burst_count,</span>
<span id="cb27-9"><a href="#cb27-9" aria-hidden="true" tabindex="-1"></a>         useful_user,</span>
<span id="cb27-10"><a href="#cb27-10" aria-hidden="true" tabindex="-1"></a>         funny_user,</span>
<span id="cb27-11"><a href="#cb27-11" aria-hidden="true" tabindex="-1"></a>         cool_user,</span>
<span id="cb27-12"><a href="#cb27-12" aria-hidden="true" tabindex="-1"></a>         star_rating_variance,</span>
<span id="cb27-13"><a href="#cb27-13" aria-hidden="true" tabindex="-1"></a>         extreme_rating_proportion, </span>
<span id="cb27-14"><a href="#cb27-14" aria-hidden="true" tabindex="-1"></a>         avg_review_length,</span>
<span id="cb27-15"><a href="#cb27-15" aria-hidden="true" tabindex="-1"></a>         review_length_variance,</span>
<span id="cb27-16"><a href="#cb27-16" aria-hidden="true" tabindex="-1"></a>         avg_sentiment,</span>
<span id="cb27-17"><a href="#cb27-17" aria-hidden="true" tabindex="-1"></a>         account_age_days,</span>
<span id="cb27-18"><a href="#cb27-18" aria-hidden="true" tabindex="-1"></a>         average_stars)</span>
<span id="cb27-19"><a href="#cb27-19" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb27-20"><a href="#cb27-20" aria-hidden="true" tabindex="-1"></a>long_user <span class="ot">&lt;-</span> review_user <span class="sc">|&gt;</span></span>
<span id="cb27-21"><a href="#cb27-21" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">names_to=</span><span class="st">"Feature"</span>, <span class="at">values_to=</span><span class="st">"Value"</span>, <span class="sc">-</span>user_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Visualize feature distributions for reviewer-level characteristics. Some users have really extreme values for the votes like ‘cool’, ‘funny’, and ‘useful’. Review count and frequency are also strongly right-skewed.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb28"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" aria-hidden="true" tabindex="-1"></a>long_user <span class="sc">|&gt;</span></span>
<span id="cb28-2"><a href="#cb28-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Value)) <span class="sc">+</span></span>
<span id="cb28-3"><a href="#cb28-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb28-4"><a href="#cb28-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Feature, <span class="at">scales=</span><span class="st">'free'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-14-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Use a log transformation to address the skewness. Use an offset of one for all transformed variables.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb29"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Consider Box-Cox transformation instead of log for heavily skewed variables</span></span>
<span id="cb29-2"><a href="#cb29-2" aria-hidden="true" tabindex="-1"></a>review_user_transformed <span class="ot">&lt;-</span> review_user <span class="sc">%&gt;%</span></span>
<span id="cb29-3"><a href="#cb29-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="fu">across</span>(</span>
<span id="cb29-4"><a href="#cb29-4" aria-hidden="true" tabindex="-1"></a>    <span class="at">.cols =</span> <span class="fu">c</span>(<span class="st">"active_days"</span>,</span>
<span id="cb29-5"><a href="#cb29-5" aria-hidden="true" tabindex="-1"></a>              <span class="st">"avg_review_length"</span>,</span>
<span id="cb29-6"><a href="#cb29-6" aria-hidden="true" tabindex="-1"></a>              <span class="st">"cool_user"</span>,</span>
<span id="cb29-7"><a href="#cb29-7" aria-hidden="true" tabindex="-1"></a>              <span class="st">"funny_user"</span>,</span>
<span id="cb29-8"><a href="#cb29-8" aria-hidden="true" tabindex="-1"></a>              <span class="st">"review_burst_count"</span>,</span>
<span id="cb29-9"><a href="#cb29-9" aria-hidden="true" tabindex="-1"></a>              <span class="st">"review_count"</span>,</span>
<span id="cb29-10"><a href="#cb29-10" aria-hidden="true" tabindex="-1"></a>              <span class="st">"review_frequency"</span>,</span>
<span id="cb29-11"><a href="#cb29-11" aria-hidden="true" tabindex="-1"></a>              <span class="st">"review_length_variance"</span>,</span>
<span id="cb29-12"><a href="#cb29-12" aria-hidden="true" tabindex="-1"></a>              <span class="st">"star_rating_variance"</span>,</span>
<span id="cb29-13"><a href="#cb29-13" aria-hidden="true" tabindex="-1"></a>              <span class="st">"time_between_reviews_variance"</span>,</span>
<span id="cb29-14"><a href="#cb29-14" aria-hidden="true" tabindex="-1"></a>              <span class="st">"useful_user"</span>),</span>
<span id="cb29-15"><a href="#cb29-15" aria-hidden="true" tabindex="-1"></a>    <span class="at">.fns =</span> log1p</span>
<span id="cb29-16"><a href="#cb29-16" aria-hidden="true" tabindex="-1"></a>  ))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Redefine <code>long_user</code> using the log-transformed data.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb30"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" aria-hidden="true" tabindex="-1"></a>long_user <span class="ot">&lt;-</span> review_user_transformed <span class="sc">|&gt;</span></span>
<span id="cb30-2"><a href="#cb30-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">names_to=</span><span class="st">"Feature"</span>, <span class="at">values_to=</span><span class="st">"Value"</span>, <span class="sc">-</span>user_id)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot feature distributions again. They are slightly improved.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb31"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" aria-hidden="true" tabindex="-1"></a>long_user <span class="sc">|&gt;</span></span>
<span id="cb31-2"><a href="#cb31-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x=</span>Value)) <span class="sc">+</span></span>
<span id="cb31-3"><a href="#cb31-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>() <span class="sc">+</span></span>
<span id="cb31-4"><a href="#cb31-4" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>Feature, <span class="at">scales=</span><span class="st">'free'</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-17-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
</section>
<section id="pca" class="level2">
<h2 class="anchored" data-anchor-id="pca">PCA</h2>
<p>Compute principal components. We center and scale all features to weight them equally.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb32"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" aria-hidden="true" tabindex="-1"></a><span class="co"># the -1 column subset excludes the user ID</span></span>
<span id="cb32-2"><a href="#cb32-2" aria-hidden="true" tabindex="-1"></a>pca <span class="ot">&lt;-</span> <span class="fu">prcomp</span>(review_user_transformed[, <span class="sc">-</span><span class="dv">1</span>], <span class="at">center=</span><span class="cn">TRUE</span>, <span class="at">scale=</span><span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>View PCA results. Three eigenvectors have eigenvalues greater than 1 (rule of thumb) and three components are able to explain 72% of the variance of the data, which is pretty high for only three components.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb33"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" aria-hidden="true" tabindex="-1"></a><span class="fu">summary</span>(pca)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code>Importance of components:
                          PC1    PC2    PC3     PC4     PC5     PC6     PC7
Standard deviation     2.5435 1.5691 1.3604 0.89605 0.86908 0.84827 0.81617
Proportion of Variance 0.4313 0.1641 0.1234 0.05353 0.05035 0.04797 0.04441
Cumulative Proportion  0.4313 0.5954 0.7188 0.77235 0.82270 0.87067 0.91508
                          PC8    PC9    PC10    PC11    PC12    PC13    PC14
Standard deviation     0.5653 0.5196 0.50290 0.44577 0.30147 0.23820 0.22518
Proportion of Variance 0.0213 0.0180 0.01686 0.01325 0.00606 0.00378 0.00338
Cumulative Proportion  0.9364 0.9544 0.97124 0.98449 0.99055 0.99433 0.99771
                          PC15
Standard deviation     0.18527
Proportion of Variance 0.00229
Cumulative Proportion  1.00000</code></pre>
</div>
</div>
<p>Eigenvalue scree plot. The red line indicates the eigenvalue = 1 threshold, which is a common rule of thumb for determining the number of components to retain. Components with eigenvalues greater than 1 are generally considered significant.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb35"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Calculate eigenvalues from PCA results</span></span>
<span id="cb35-2"><a href="#cb35-2" aria-hidden="true" tabindex="-1"></a>eigenvalues <span class="ot">&lt;-</span> pca<span class="sc">$</span>sdev<span class="sc">^</span><span class="dv">2</span></span>
<span id="cb35-3"><a href="#cb35-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb35-4"><a href="#cb35-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Create a scree plot</span></span>
<span id="cb35-5"><a href="#cb35-5" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(</span>
<span id="cb35-6"><a href="#cb35-6" aria-hidden="true" tabindex="-1"></a>  <span class="at">PC =</span> <span class="dv">1</span><span class="sc">:</span><span class="fu">length</span>(eigenvalues),</span>
<span id="cb35-7"><a href="#cb35-7" aria-hidden="true" tabindex="-1"></a>  <span class="at">Eigenvalue =</span> eigenvalues,</span>
<span id="cb35-8"><a href="#cb35-8" aria-hidden="true" tabindex="-1"></a>  <span class="at">Proportion =</span> eigenvalues <span class="sc">/</span> <span class="fu">sum</span>(eigenvalues),</span>
<span id="cb35-9"><a href="#cb35-9" aria-hidden="true" tabindex="-1"></a>  <span class="at">Cumulative =</span> <span class="fu">cumsum</span>(Proportion)</span>
<span id="cb35-10"><a href="#cb35-10" aria-hidden="true" tabindex="-1"></a>) <span class="sc">|&gt;</span></span>
<span id="cb35-11"><a href="#cb35-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> PC, <span class="at">y =</span> Eigenvalue)) <span class="sc">+</span></span>
<span id="cb35-12"><a href="#cb35-12" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_point</span>() <span class="sc">+</span></span>
<span id="cb35-13"><a href="#cb35-13" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span></span>
<span id="cb35-14"><a href="#cb35-14" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_hline</span>(<span class="at">yintercept =</span> <span class="dv">1</span>, <span class="at">linetype =</span> <span class="st">"dashed"</span>, <span class="at">color =</span> <span class="st">"red"</span>) <span class="sc">+</span></span>
<span id="cb35-15"><a href="#cb35-15" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"Scree Plot"</span>, <span class="at">subtitle =</span> <span class="st">"Red line shows eigenvalue = 1 threshold"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-20-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Plot the distribution of PC1.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb36"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" aria-hidden="true" tabindex="-1"></a><span class="fu">as_tibble</span>(pca<span class="sc">$</span>x[, <span class="dv">1</span>]) <span class="sc">|&gt;</span></span>
<span id="cb36-2"><a href="#cb36-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> value)) <span class="sc">+</span></span>
<span id="cb36-3"><a href="#cb36-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-21-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Plot directional loadings for PC1 and PC2.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb37"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" aria-hidden="true" tabindex="-1"></a><span class="co"># To visualize component loadings more clearly</span></span>
<span id="cb37-2"><a href="#cb37-2" aria-hidden="true" tabindex="-1"></a><span class="fu">fviz_pca_var</span>(pca, <span class="at">col.var =</span> <span class="st">"contrib"</span>, </span>
<span id="cb37-3"><a href="#cb37-3" aria-hidden="true" tabindex="-1"></a>             <span class="at">gradient.cols =</span> <span class="fu">c</span>(<span class="st">"#00AFBB"</span>, <span class="st">"#E7B800"</span>, <span class="st">"#FC4E07"</span>),</span>
<span id="cb37-4"><a href="#cb37-4" aria-hidden="true" tabindex="-1"></a>             <span class="at">repel =</span> <span class="cn">TRUE</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-22-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Visualize loadings for the first three components. The loadings indicate how much each feature contributes to each principal component. Positive loadings indicate a positive relationship with the component, while negative loadings indicate a negative relationship.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb38"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Examine loadings for first 3 components</span></span>
<span id="cb38-2"><a href="#cb38-2" aria-hidden="true" tabindex="-1"></a>loadings_df <span class="ot">&lt;-</span> <span class="fu">as_tibble</span>(pca<span class="sc">$</span>rotation[, <span class="dv">1</span><span class="sc">:</span><span class="dv">3</span>], <span class="at">rownames =</span> <span class="st">"Feature"</span>)</span>
<span id="cb38-3"><a href="#cb38-3" aria-hidden="true" tabindex="-1"></a></span>
<span id="cb38-4"><a href="#cb38-4" aria-hidden="true" tabindex="-1"></a><span class="co"># Visualize loadings</span></span>
<span id="cb38-5"><a href="#cb38-5" aria-hidden="true" tabindex="-1"></a>loadings_df <span class="sc">|&gt;</span></span>
<span id="cb38-6"><a href="#cb38-6" aria-hidden="true" tabindex="-1"></a>  <span class="fu">pivot_longer</span>(<span class="at">cols =</span> <span class="sc">-</span>Feature, <span class="at">names_to =</span> <span class="st">"PC"</span>, <span class="at">values_to =</span> <span class="st">"Loading"</span>) <span class="sc">|&gt;</span></span>
<span id="cb38-7"><a href="#cb38-7" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> <span class="fu">reorder</span>(Feature, Loading), <span class="at">y =</span> Loading, <span class="at">fill =</span> Loading <span class="sc">&gt;</span> <span class="dv">0</span>)) <span class="sc">+</span></span>
<span id="cb38-8"><a href="#cb38-8" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_col</span>() <span class="sc">+</span></span>
<span id="cb38-9"><a href="#cb38-9" aria-hidden="true" tabindex="-1"></a>  <span class="fu">facet_wrap</span>(<span class="sc">~</span>PC) <span class="sc">+</span></span>
<span id="cb38-10"><a href="#cb38-10" aria-hidden="true" tabindex="-1"></a>  <span class="fu">coord_flip</span>() <span class="sc">+</span></span>
<span id="cb38-11"><a href="#cb38-11" aria-hidden="true" tabindex="-1"></a>  <span class="fu">labs</span>(<span class="at">title =</span> <span class="st">"PCA Loadings for First 3 Components"</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-23-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>Interpret the first three eigenvectors.</p>
<p>Interpretation of PC1:</p>
<p>Interpretation of PC2:</p>
<p>Interpretation of PC3:</p>
<p>Use min-max scaling to transform PC1 values to 0 to 1 scale.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb39"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" aria-hidden="true" tabindex="-1"></a><span class="co"># Min-max scaling for PC1</span></span>
<span id="cb39-2"><a href="#cb39-2" aria-hidden="true" tabindex="-1"></a>trust_scores <span class="ot">&lt;-</span> (pca<span class="sc">$</span>x[, <span class="dv">1</span>] <span class="sc">-</span> <span class="fu">min</span>(pca<span class="sc">$</span>x[, <span class="dv">1</span>])) <span class="sc">/</span> (<span class="fu">max</span>(pca<span class="sc">$</span>x[, <span class="dv">1</span>]) <span class="sc">-</span> <span class="fu">min</span>(pca<span class="sc">$</span>x[, <span class="dv">1</span>]))</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Plot trust scores.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb40"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" aria-hidden="true" tabindex="-1"></a><span class="fu">tibble</span>(<span class="at">score =</span> trust_scores) <span class="sc">|&gt;</span></span>
<span id="cb40-2"><a href="#cb40-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">ggplot</span>(<span class="fu">aes</span>(<span class="at">x =</span> score)) <span class="sc">+</span></span>
<span id="cb40-3"><a href="#cb40-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">geom_density</span>()</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output-display">
<div>
<figure class="figure">
<p><img src="pca_scoring_files/figure-html/unnamed-chunk-25-1.png" class="img-fluid figure-img" width="672"></p>
</figure>
</div>
</div>
</div>
<p>What do some of the people look like at either end of this distribution?</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb41"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" aria-hidden="true" tabindex="-1"></a><span class="co"># add trust score variable to user level data</span></span>
<span id="cb41-2"><a href="#cb41-2" aria-hidden="true" tabindex="-1"></a>review_user <span class="ot">&lt;-</span> review_user <span class="sc">|&gt;</span></span>
<span id="cb41-3"><a href="#cb41-3" aria-hidden="true" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">trust_scores =</span> trust_scores)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
</div>
<p>Top 5 trustworthy users.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb42"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" aria-hidden="true" tabindex="-1"></a>review_user <span class="sc">|&gt;</span></span>
<span id="cb42-2"><a href="#cb42-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_max</span>(trust_scores, <span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 306 × 17
   user_id      active_days review_count review_frequency time_between_reviews…¹
   &lt;chr&gt;              &lt;dbl&gt;        &lt;dbl&gt;            &lt;dbl&gt;                  &lt;dbl&gt;
 1 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 2 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 3 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 4 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 5 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 6 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 7 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 8 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
 9 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
10 Hi10sGSZNxQ…        4033        17473           0.0759                  3940.
# ℹ 296 more rows
# ℹ abbreviated name: ¹​time_between_reviews_variance
# ℹ 12 more variables: review_burst_count &lt;int&gt;, useful_user &lt;dbl&gt;,
#   funny_user &lt;dbl&gt;, cool_user &lt;dbl&gt;, star_rating_variance &lt;dbl&gt;,
#   extreme_rating_proportion &lt;dbl&gt;, avg_review_length &lt;dbl&gt;,
#   review_length_variance &lt;dbl&gt;, avg_sentiment &lt;dbl&gt;, account_age_days &lt;dbl&gt;,
#   average_stars &lt;dbl&gt;, trust_scores &lt;dbl&gt;</code></pre>
</div>
</div>
<p>Top 5 untrustworthy users.</p>
<div class="cell">
<div class="sourceCode cell-code" id="cb44"><pre class="sourceCode r code-with-copy"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" aria-hidden="true" tabindex="-1"></a>review_user <span class="sc">|&gt;</span></span>
<span id="cb44-2"><a href="#cb44-2" aria-hidden="true" tabindex="-1"></a>  <span class="fu">slice_min</span>(trust_scores, <span class="at">n=</span><span class="dv">5</span>)</span></code><button title="Copy to Clipboard" class="code-copy-button"><i class="bi"></i></button></pre></div>
<div class="cell-output cell-output-stdout">
<pre><code># A tibble: 5 × 17
  user_id       active_days review_count review_frequency time_between_reviews…¹
  &lt;chr&gt;               &lt;dbl&gt;        &lt;dbl&gt;            &lt;dbl&gt;                  &lt;dbl&gt;
1 w-u9XSX5SksC…           1            1                1                      0
2 NCxkHUGQFLUm…           1            1                1                      0
3 3hVFEgVTUoWR…           1            1                1                      0
4 KrXr7kV-JWfO…           1            1                1                      0
5 BQuZAD2Z7R67…           1            1                1                      0
# ℹ abbreviated name: ¹​time_between_reviews_variance
# ℹ 12 more variables: review_burst_count &lt;int&gt;, useful_user &lt;dbl&gt;,
#   funny_user &lt;dbl&gt;, cool_user &lt;dbl&gt;, star_rating_variance &lt;dbl&gt;,
#   extreme_rating_proportion &lt;dbl&gt;, avg_review_length &lt;dbl&gt;,
#   review_length_variance &lt;dbl&gt;, avg_sentiment &lt;dbl&gt;, account_age_days &lt;dbl&gt;,
#   average_stars &lt;dbl&gt;, trust_scores &lt;dbl&gt;</code></pre>
</div>
</div>
</section>

</main>
<!-- /main column -->
<script id="quarto-html-after-body" type="application/javascript">
window.document.addEventListener("DOMContentLoaded", function (event) {
  const toggleBodyColorMode = (bsSheetEl) => {
    const mode = bsSheetEl.getAttribute("data-mode");
    const bodyEl = window.document.querySelector("body");
    if (mode === "dark") {
      bodyEl.classList.add("quarto-dark");
      bodyEl.classList.remove("quarto-light");
    } else {
      bodyEl.classList.add("quarto-light");
      bodyEl.classList.remove("quarto-dark");
    }
  }
  const toggleBodyColorPrimary = () => {
    const bsSheetEl = window.document.querySelector("link#quarto-bootstrap");
    if (bsSheetEl) {
      toggleBodyColorMode(bsSheetEl);
    }
  }
  toggleBodyColorPrimary();  
  const icon = "";
  const anchorJS = new window.AnchorJS();
  anchorJS.options = {
    placement: 'right',
    icon: icon
  };
  anchorJS.add('.anchored');
  const isCodeAnnotation = (el) => {
    for (const clz of el.classList) {
      if (clz.startsWith('code-annotation-')) {                     
        return true;
      }
    }
    return false;
  }
  const onCopySuccess = function(e) {
    // button target
    const button = e.trigger;
    // don't keep focus
    button.blur();
    // flash "checked"
    button.classList.add('code-copy-button-checked');
    var currentTitle = button.getAttribute("title");
    button.setAttribute("title", "Copied!");
    let tooltip;
    if (window.bootstrap) {
      button.setAttribute("data-bs-toggle", "tooltip");
      button.setAttribute("data-bs-placement", "left");
      button.setAttribute("data-bs-title", "Copied!");
      tooltip = new bootstrap.Tooltip(button, 
        { trigger: "manual", 
          customClass: "code-copy-button-tooltip",
          offset: [0, -8]});
      tooltip.show();    
    }
    setTimeout(function() {
      if (tooltip) {
        tooltip.hide();
        button.removeAttribute("data-bs-title");
        button.removeAttribute("data-bs-toggle");
        button.removeAttribute("data-bs-placement");
      }
      button.setAttribute("title", currentTitle);
      button.classList.remove('code-copy-button-checked');
    }, 1000);
    // clear code selection
    e.clearSelection();
  }
  const getTextToCopy = function(trigger) {
      const codeEl = trigger.previousElementSibling.cloneNode(true);
      for (const childEl of codeEl.children) {
        if (isCodeAnnotation(childEl)) {
          childEl.remove();
        }
      }
      return codeEl.innerText;
  }
  const clipboard = new window.ClipboardJS('.code-copy-button:not([data-in-quarto-modal])', {
    text: getTextToCopy
  });
  clipboard.on('success', onCopySuccess);
  if (window.document.getElementById('quarto-embedded-source-code-modal')) {
    const clipboardModal = new window.ClipboardJS('.code-copy-button[data-in-quarto-modal]', {
      text: getTextToCopy,
      container: window.document.getElementById('quarto-embedded-source-code-modal')
    });
    clipboardModal.on('success', onCopySuccess);
  }
    var localhostRegex = new RegExp(/^(?:http|https):\/\/localhost\:?[0-9]*\//);
    var mailtoRegex = new RegExp(/^mailto:/);
      var filterRegex = new RegExp('/' + window.location.host + '/');
    var isInternal = (href) => {
        return filterRegex.test(href) || localhostRegex.test(href) || mailtoRegex.test(href);
    }
    // Inspect non-navigation links and adorn them if external
 	var links = window.document.querySelectorAll('a[href]:not(.nav-link):not(.navbar-brand):not(.toc-action):not(.sidebar-link):not(.sidebar-item-toggle):not(.pagination-link):not(.no-external):not([aria-hidden]):not(.dropdown-item):not(.quarto-navigation-tool):not(.about-link)');
    for (var i=0; i<links.length; i++) {
      const link = links[i];
      if (!isInternal(link.href)) {
        // undo the damage that might have been done by quarto-nav.js in the case of
        // links that we want to consider external
        if (link.dataset.originalHref !== undefined) {
          link.href = link.dataset.originalHref;
        }
      }
    }
  function tippyHover(el, contentFn, onTriggerFn, onUntriggerFn) {
    const config = {
      allowHTML: true,
      maxWidth: 500,
      delay: 100,
      arrow: false,
      appendTo: function(el) {
          return el.parentElement;
      },
      interactive: true,
      interactiveBorder: 10,
      theme: 'quarto',
      placement: 'bottom-start',
    };
    if (contentFn) {
      config.content = contentFn;
    }
    if (onTriggerFn) {
      config.onTrigger = onTriggerFn;
    }
    if (onUntriggerFn) {
      config.onUntrigger = onUntriggerFn;
    }
    window.tippy(el, config); 
  }
  const noterefs = window.document.querySelectorAll('a[role="doc-noteref"]');
  for (var i=0; i<noterefs.length; i++) {
    const ref = noterefs[i];
    tippyHover(ref, function() {
      // use id or data attribute instead here
      let href = ref.getAttribute('data-footnote-href') || ref.getAttribute('href');
      try { href = new URL(href).hash; } catch {}
      const id = href.replace(/^#\/?/, "");
      const note = window.document.getElementById(id);
      if (note) {
        return note.innerHTML;
      } else {
        return "";
      }
    });
  }
  const xrefs = window.document.querySelectorAll('a.quarto-xref');
  const processXRef = (id, note) => {
    // Strip column container classes
    const stripColumnClz = (el) => {
      el.classList.remove("page-full", "page-columns");
      if (el.children) {
        for (const child of el.children) {
          stripColumnClz(child);
        }
      }
    }
    stripColumnClz(note)
    if (id === null || id.startsWith('sec-')) {
      // Special case sections, only their first couple elements
      const container = document.createElement("div");
      if (note.children && note.children.length > 2) {
        container.appendChild(note.children[0].cloneNode(true));
        for (let i = 1; i < note.children.length; i++) {
          const child = note.children[i];
          if (child.tagName === "P" && child.innerText === "") {
            continue;
          } else {
            container.appendChild(child.cloneNode(true));
            break;
          }
        }
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(container);
        }
        return container.innerHTML
      } else {
        if (window.Quarto?.typesetMath) {
          window.Quarto.typesetMath(note);
        }
        return note.innerHTML;
      }
    } else {
      // Remove any anchor links if they are present
      const anchorLink = note.querySelector('a.anchorjs-link');
      if (anchorLink) {
        anchorLink.remove();
      }
      if (window.Quarto?.typesetMath) {
        window.Quarto.typesetMath(note);
      }
      if (note.classList.contains("callout")) {
        return note.outerHTML;
      } else {
        return note.innerHTML;
      }
    }
  }
  for (var i=0; i<xrefs.length; i++) {
    const xref = xrefs[i];
    tippyHover(xref, undefined, function(instance) {
      instance.disable();
      let url = xref.getAttribute('href');
      let hash = undefined; 
      if (url.startsWith('#')) {
        hash = url;
      } else {
        try { hash = new URL(url).hash; } catch {}
      }
      if (hash) {
        const id = hash.replace(/^#\/?/, "");
        const note = window.document.getElementById(id);
        if (note !== null) {
          try {
            const html = processXRef(id, note.cloneNode(true));
            instance.setContent(html);
          } finally {
            instance.enable();
            instance.show();
          }
        } else {
          // See if we can fetch this
          fetch(url.split('#')[0])
          .then(res => res.text())
          .then(html => {
            const parser = new DOMParser();
            const htmlDoc = parser.parseFromString(html, "text/html");
            const note = htmlDoc.getElementById(id);
            if (note !== null) {
              const html = processXRef(id, note);
              instance.setContent(html);
            } 
          }).finally(() => {
            instance.enable();
            instance.show();
          });
        }
      } else {
        // See if we can fetch a full url (with no hash to target)
        // This is a special case and we should probably do some content thinning / targeting
        fetch(url)
        .then(res => res.text())
        .then(html => {
          const parser = new DOMParser();
          const htmlDoc = parser.parseFromString(html, "text/html");
          const note = htmlDoc.querySelector('main.content');
          if (note !== null) {
            // This should only happen for chapter cross references
            // (since there is no id in the URL)
            // remove the first header
            if (note.children.length > 0 && note.children[0].tagName === "HEADER") {
              note.children[0].remove();
            }
            const html = processXRef(null, note);
            instance.setContent(html);
          } 
        }).finally(() => {
          instance.enable();
          instance.show();
        });
      }
    }, function(instance) {
    });
  }
      let selectedAnnoteEl;
      const selectorForAnnotation = ( cell, annotation) => {
        let cellAttr = 'data-code-cell="' + cell + '"';
        let lineAttr = 'data-code-annotation="' +  annotation + '"';
        const selector = 'span[' + cellAttr + '][' + lineAttr + ']';
        return selector;
      }
      const selectCodeLines = (annoteEl) => {
        const doc = window.document;
        const targetCell = annoteEl.getAttribute("data-target-cell");
        const targetAnnotation = annoteEl.getAttribute("data-target-annotation");
        const annoteSpan = window.document.querySelector(selectorForAnnotation(targetCell, targetAnnotation));
        const lines = annoteSpan.getAttribute("data-code-lines").split(",");
        const lineIds = lines.map((line) => {
          return targetCell + "-" + line;
        })
        let top = null;
        let height = null;
        let parent = null;
        if (lineIds.length > 0) {
            //compute the position of the single el (top and bottom and make a div)
            const el = window.document.getElementById(lineIds[0]);
            top = el.offsetTop;
            height = el.offsetHeight;
            parent = el.parentElement.parentElement;
          if (lineIds.length > 1) {
            const lastEl = window.document.getElementById(lineIds[lineIds.length - 1]);
            const bottom = lastEl.offsetTop + lastEl.offsetHeight;
            height = bottom - top;
          }
          if (top !== null && height !== null && parent !== null) {
            // cook up a div (if necessary) and position it 
            let div = window.document.getElementById("code-annotation-line-highlight");
            if (div === null) {
              div = window.document.createElement("div");
              div.setAttribute("id", "code-annotation-line-highlight");
              div.style.position = 'absolute';
              parent.appendChild(div);
            }
            div.style.top = top - 2 + "px";
            div.style.height = height + 4 + "px";
            div.style.left = 0;
            let gutterDiv = window.document.getElementById("code-annotation-line-highlight-gutter");
            if (gutterDiv === null) {
              gutterDiv = window.document.createElement("div");
              gutterDiv.setAttribute("id", "code-annotation-line-highlight-gutter");
              gutterDiv.style.position = 'absolute';
              const codeCell = window.document.getElementById(targetCell);
              const gutter = codeCell.querySelector('.code-annotation-gutter');
              gutter.appendChild(gutterDiv);
            }
            gutterDiv.style.top = top - 2 + "px";
            gutterDiv.style.height = height + 4 + "px";
          }
          selectedAnnoteEl = annoteEl;
        }
      };
      const unselectCodeLines = () => {
        const elementsIds = ["code-annotation-line-highlight", "code-annotation-line-highlight-gutter"];
        elementsIds.forEach((elId) => {
          const div = window.document.getElementById(elId);
          if (div) {
            div.remove();
          }
        });
        selectedAnnoteEl = undefined;
      };
        // Handle positioning of the toggle
    window.addEventListener(
      "resize",
      throttle(() => {
        elRect = undefined;
        if (selectedAnnoteEl) {
          selectCodeLines(selectedAnnoteEl);
        }
      }, 10)
    );
    function throttle(fn, ms) {
    let throttle = false;
    let timer;
      return (...args) => {
        if(!throttle) { // first call gets through
            fn.apply(this, args);
            throttle = true;
        } else { // all the others get throttled
            if(timer) clearTimeout(timer); // cancel #2
            timer = setTimeout(() => {
              fn.apply(this, args);
              timer = throttle = false;
            }, ms);
        }
      };
    }
      // Attach click handler to the DT
      const annoteDls = window.document.querySelectorAll('dt[data-target-cell]');
      for (const annoteDlNode of annoteDls) {
        annoteDlNode.addEventListener('click', (event) => {
          const clickedEl = event.target;
          if (clickedEl !== selectedAnnoteEl) {
            unselectCodeLines();
            const activeEl = window.document.querySelector('dt[data-target-cell].code-annotation-active');
            if (activeEl) {
              activeEl.classList.remove('code-annotation-active');
            }
            selectCodeLines(clickedEl);
            clickedEl.classList.add('code-annotation-active');
          } else {
            // Unselect the line
            unselectCodeLines();
            clickedEl.classList.remove('code-annotation-active');
          }
        });
      }
  const findCites = (el) => {
    const parentEl = el.parentElement;
    if (parentEl) {
      const cites = parentEl.dataset.cites;
      if (cites) {
        return {
          el,
          cites: cites.split(' ')
        };
      } else {
        return findCites(el.parentElement)
      }
    } else {
      return undefined;
    }
  };
  var bibliorefs = window.document.querySelectorAll('a[role="doc-biblioref"]');
  for (var i=0; i<bibliorefs.length; i++) {
    const ref = bibliorefs[i];
    const citeInfo = findCites(ref);
    if (citeInfo) {
      tippyHover(citeInfo.el, function() {
        var popup = window.document.createElement('div');
        citeInfo.cites.forEach(function(cite) {
          var citeDiv = window.document.createElement('div');
          citeDiv.classList.add('hanging-indent');
          citeDiv.classList.add('csl-entry');
          var biblioDiv = window.document.getElementById('ref-' + cite);
          if (biblioDiv) {
            citeDiv.innerHTML = biblioDiv.innerHTML;
          }
          popup.appendChild(citeDiv);
        });
        return popup.innerHTML;
      });
    }
  }
});
</script>
</div> <!-- /content -->




</body></html>